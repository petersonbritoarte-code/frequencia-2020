<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Sweep 20Hz–20kHz + Contador Sincronizado</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Freq 20/20">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{ color-scheme: dark; --accent:#8bd3ff; }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    background:#000;
    min-height:100svh;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: 0;
  }

  .stage{
    width:100%;
    min-height:100svh;
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    padding: calc(16px + env(safe-area-inset-top)) 16px calc(16px + env(safe-area-inset-bottom));
  }

  /* HUD */
  .hud{
    position:absolute;
    top:14px;
    left:14px;
    right:14px;
    display:flex;
    justify-content:space-between;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    z-index:10;
    pointer-events:none; /* evita bloquear toque no mobile */
  }

  .pill{
    pointer-events:none;
    display:flex;
    gap:10px;
    align-items:center;
    padding:10px 12px;
    border:1px solid #1f1f1f;
    background: rgba(10,10,10,.75);
    backdrop-filter: blur(6px);
    border-radius:14px;
    color:#c9cdd1;
    font-size:13px;
    white-space:nowrap;
  }

  .pill b{
    color:#e8eaed;
    font-family:ui-monospace,Menlo,Consolas,monospace;
    font-weight:800;
  }

  .dot{
    width:10px;height:10px;border-radius:50%;
    background:var(--accent);
    box-shadow: 0 0 14px rgba(255,255,255,.08);
  }

  /* Centro */
  .center{
    text-align:center;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    width:min(980px, 100%);
    padding-top: 70px; /* espaço para HUD (desktop) */
  }

  #brandTop{
    font-size: 17px;
    font-weight: 800;
    color: #ffffff;
    opacity: 0.95;
    letter-spacing: 0.4px;
    margin-bottom: 4px;
  }

  #bandLabel{
    font-size:18px;
    font-weight:850;
    letter-spacing:.7px;
    text-transform:uppercase;
    color:var(--accent);
  }

  #freq{
    font-family:ui-monospace,Menlo,Consolas,monospace;
    font-size:clamp(78px,10.5vw,142px);
    font-weight:900;
    color:var(--accent);
    line-height:1;
    transition:color .2s linear;
    text-shadow: 0 0 18px rgba(255,255,255,.06);
  }

  #bandTip{
    max-width:900px;
    font-size:16px;
    color:#b8bcc1;
    line-height:1.45;
    min-height:2.6em;
  }

  .safety{
    max-width:900px;
    margin-top:6px;
    padding:12px 14px;
    border-radius:16px;
    border:1px solid #2a1f00;
    background:#0f0c00;
    color:#e8eaed;
    font-size:14px;
    line-height:1.4;
  }
  .safety strong{ color:#ffd36a; }

  .controlsCenter{
    margin-top:10px;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
    justify-content:center;
    width:min(900px, 100%);
  }

  .controlsRow{
    display:flex;
    gap:14px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
    width:100%;
  }

  button{
    appearance:none;
    border:1px solid #2b2b2b;
    background:#111;
    color:#e8eaed;
    padding:14px 20px;
    border-radius:16px;
    font-weight:800;
    cursor:pointer;
    font-size:15px;
  }
  button:hover{ background:#151515; }
  button:disabled{ opacity:.5; cursor:not-allowed; }

  .volBox, .seekBox{
    display:flex;
    gap:12px;
    align-items:center;
    padding:12px 14px;
    border:1px solid #1f1f1f;
    background: rgba(10,10,10,.75);
    backdrop-filter: blur(6px);
    border-radius:16px;
    color:#c9cdd1;
    font-size:14px;
    width:min(760px, 100%);
    justify-content:center;
    flex-wrap:wrap;
  }

  input[type="range"]{
    width: 320px;
    touch-action: pan-y; /* ajuda no iOS para arrastar slider */
  }

  .mono{
    font-family:ui-monospace,Menlo,Consolas,monospace;
    color:#e8eaed;
    font-weight:800;
  }

  /* Mobile: empilha HUD e evita sobreposição */
  @media (max-width: 720px){
    .center{ padding-top: 0; }

    .hud{
      position:static;
      width:100%;
      justify-content:center;
      gap:10px;
      margin-bottom: 10px;
      pointer-events:none;
    }
    .pill{
      width:100%;
      justify-content:center;
      text-align:center;
      white-space:normal;
    }

    #brandTop{ font-size:16px; margin-bottom:2px; }
    #bandLabel{ font-size:15px; }
    #freq{ font-size:clamp(54px,16vw,92px); }

    #bandTip{ font-size:14px; }
    .safety{ font-size:13px; }

    .volBox, .seekBox{ width:100%; }
    input[type="range"]{ width:min(260px, 80vw); }

    button{ padding:14px 22px; font-size:16px; }
  }
</style>
</head>

<body>
  <div class="stage">

    <div class="hud">
      <div class="pill">
        <span class="dot"></span>
        <span>Sweep</span>
        <b>20 → 20.000 Hz</b>
        <span>•</span>
        <span>Curva</span>
        <b>LOG</b>
      </div>

      <div class="pill">
        <span>Sample rate</span> <b id="srInfo">—</b>
        <span>•</span>
        <span>Ganho</span> <b id="gainInfo">—</b>
      </div>
    </div>

    <div class="center">
      <div id="brandTop">youtube.com/@ProfPetersonBrito</div>

      <div id="bandLabel">SUBGRAVE (20–40 Hz)</div>
      <div id="freq">20 Hz</div>
      <div id="bandTip">Sensação física e “peso”. Mais sentido no corpo do que no ouvido.</div>

      <div class="safety">
        <strong>Segurança:</strong>
        Comece com volume baixo. Sweeps (Varreduras) podem ficar agressivos em 2–5 kHz.<br>
        Evite fones no máximo, faça pausas e interrompa ao menor sinal de desconforto.<br>
        O “dBFS” exibido é ganho digital (não é SPL no ouvido). O volume real depende também de seu equipamento e ajustes pessoais.
      </div>

      <div class="controlsCenter">
        <div class="controlsRow">
          <button id="startBtn">Iniciar</button>
          <button id="stopBtn" disabled>Parar</button>
        </div>

        <div class="volBox">
          <span>Volume</span>
          <input id="vol" type="range" min="0" max="1" step="0.001" value="0.08">
          <b id="volLabel" class="mono">8%</b>
        </div>

        <div class="seekBox">
          <span>Posição</span>
          <input id="seek" type="range" min="0" max="300" step="0.01" value="0">
          <b id="seekLabel" class="mono">00:00 / 05:00</b>
          <span style="color:#9aa0a6;">•</span>
          <span>Prog.</span>
          <b id="progInfo" class="mono">0%</b>
        </div>
      </div>
    </div>

  </div>

<script>
(() => {
  // Bandas + cor + dica
  const BANDS = [
    { n:"Subgrave",    min:20,   max:40,      c:"#8bd3ff", t:"Sensação física e “peso”. Mais sentido no corpo do que no ouvido." },
    { n:"Grave-Baixo", min:40,   max:80,      c:"#66e0ff", t:"Fundação do grave. Base rítmica e sustentação do low-end." },
    { n:"Grave-Alto",  min:80,   max:200,     c:"#4ff2d6", t:"Punch e impacto. Excesso aqui costuma embolar/mascarar." },
    { n:"Médio-Grave", min:200,  max:500,     c:"#72ff7a", t:"Corpo e ressonância (“boxy”). Pode soar abafado se exagerar." },
    { n:"Médio-Médio", min:500,  max:1500,    c:"#cfff6a", t:"Centro do timbre. Dá “leitura”, mas pode ficar nasal/duro." },
    { n:"Médio-Agudo", min:1500, max:5000,    c:"#ffe66a", t:"Presença e inteligibilidade. Região sensível do ouvido: cuidado." },
    { n:"Agudo",       min:5000, max:12000,   c:"#ffb86a", t:"Brilho e ataque. Pode evidenciar sibilância/aspereza." },
    { n:"Super-Agudo", min:12000,max:20000.1, c:"#ff4d4d", t:"“Ar” e cintilância. Fácil causar fadiga em volumes altos." }
  ];

  const fStart = 20, fEnd = 20000, duration = 300;

  // WebAudio
  let ctx = null, osc = null, gain = null, raf = null;
  let tStart = 0, tEnd = 0;
  let lastBand = -1;

  // Estado
  let offsetSec = 0;
  let isRunning = false;
  let isUserDrag = false;

  // UI
  const freqEl = document.getElementById("freq");
  const bandEl = document.getElementById("bandLabel");
  const tipEl  = document.getElementById("bandTip");

  const startBtn = document.getElementById("startBtn");
  const stopBtn  = document.getElementById("stopBtn");

  const vol = document.getElementById("vol");
  const volLabel = document.getElementById("volLabel");

  const seek = document.getElementById("seek");
  const seekLabel = document.getElementById("seekLabel");
  const progInfo = document.getElementById("progInfo");

  const srInfo   = document.getElementById("srInfo");
  const gainInfo = document.getElementById("gainInfo");

  function pad2(n){ return String(n).padStart(2,"0"); }
  function fmtTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec/60), s = sec%60;
    return `${pad2(m)}:${pad2(s)}`;
  }
  function fmtHz(f){ return Math.round(f).toLocaleString("pt-BR") + " Hz"; }

  function gainToDbfs(g){
    const x = Math.max(0.000001, g);
    return 20 * Math.log10(x);
  }

  function bandIndexFor(f){
    for (let i=0;i<BANDS.length;i++){
      const b=BANDS[i];
      if (f>=b.min && f<b.max) return i;
    }
    return BANDS.length-1;
  }

  function applyBand(i){
    const b = BANDS[i];
    const maxShown = (b.max>20000) ? "20.000" : String(Math.round(b.max));
    bandEl.textContent = `${b.n.toUpperCase()} (${b.min}–${maxShown} Hz)`;
    tipEl.textContent = b.t;
    document.documentElement.style.setProperty("--accent", b.c);
  }

  function freqAt(t){
    const p = Math.min(Math.max(t / duration, 0), 1);
    return fStart * Math.pow(fEnd/fStart, p);
  }

  function updateSeekUI(t){
    const p = Math.min(Math.max(t / duration, 0), 1);
    seekLabel.textContent = `${fmtTime(t)} / ${fmtTime(duration)}`;
    progInfo.textContent = `${Math.round(p*100)}%`;
  }

  function previewAt(t){
    const f = freqAt(t);
    freqEl.textContent = fmtHz(f);

    const bi = bandIndexFor(f);
    applyBand(bi);
    lastBand = bi;

    updateSeekUI(t);
  }

  function setRunning(r){
    isRunning = r;
    startBtn.disabled = r;
    stopBtn.disabled  = !r;
  }

  function ensureCtx(){
    if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
    return ctx;
  }

  async function ensureAudioRunning(){
    ensureCtx();
    if (ctx.state === "suspended") {
      try { await ctx.resume(); } catch(e) {}
    }
  }

  function stopOscOnly(){
    if (!ctx || !osc) return;

    const now = ctx.currentTime;

    if (gain){
      gain.gain.cancelScheduledValues(now);
      gain.gain.setValueAtTime(gain.gain.value, now);
      gain.gain.linearRampToValueAtTime(0.00001, now + 0.03);
    }

    try { osc.stop(now + 0.04); } catch(e) {}
    osc = null;
  }

  async function startFromOffset(newOffset){
    // mobile-safe: gesto do usuário -> resume
    await ensureAudioRunning();

    // se já tocando, para só o oscilador (mantém ctx vivo e gesto válido)
    if (osc) stopOscOnly();

    offsetSec = Math.min(Math.max(newOffset, 0), duration);
    seek.value = String(offsetSec);

    if (offsetSec >= duration) {
      previewAt(duration);
      setRunning(false);
      return;
    }

    // cria osc/gain dentro do mesmo ctx
    osc = ctx.createOscillator();
    gain = ctx.createGain();
    osc.type = "sine";

    const g0 = Math.max(0.00001, Number(vol.value));
    gain.gain.value = g0;

    osc.connect(gain);
    gain.connect(ctx.destination);

    const now = ctx.currentTime;
    tStart = now + 0.05;
    const remaining = duration - offsetSec;
    tEnd = tStart + remaining;

    const f0 = freqAt(offsetSec);
    osc.frequency.setValueAtTime(f0, tStart);
    osc.frequency.exponentialRampToValueAtTime(fEnd, tEnd);

    srInfo.textContent = `${Math.round(ctx.sampleRate)} Hz`;
    gainInfo.textContent = `${g0.toFixed(3)} (≈ ${gainToDbfs(g0).toFixed(1)} dBFS)`;

    previewAt(offsetSec);

    osc.start(tStart);
    osc.stop(tEnd);

    setRunning(true);

    if (raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(loop);
  }

  function loop(){
    if (!ctx || !osc) return;

    const now = ctx.currentTime;
    const tAudio = now - tStart;
    const t = offsetSec + tAudio;

    const f = freqAt(t);
    freqEl.textContent = fmtHz(f);

    const bi = bandIndexFor(f);
    if (bi !== lastBand){
      applyBand(bi);
      lastBand = bi;
    }

    if (!isUserDrag){
      const clamped = Math.min(Math.max(t, 0), duration);
      seek.value = String(clamped);
      updateSeekUI(clamped);
    }

    const g = gain ? gain.gain.value : Number(vol.value);
    gainInfo.textContent = `${g.toFixed(3)} (≈ ${gainToDbfs(g).toFixed(1)} dBFS)`;

    if (now < tEnd) {
      raf = requestAnimationFrame(loop);
    } else {
      // terminou
      offsetSec = duration;
      setRunning(false);
      stopOscOnly();
      previewAt(offsetSec);
    }
  }

  // Volume
  vol.addEventListener("input", () => {
    const v = Number(vol.value);
    volLabel.textContent = Math.round(v*100) + "%";
    gainInfo.textContent = `${v.toFixed(3)} (≈ ${gainToDbfs(v).toFixed(1)} dBFS)`;

    if (gain && ctx){
      const now = ctx.currentTime;
      gain.gain.setTargetAtTime(Math.max(0.00001, v), now, 0.02);
    }
  });

  // Seek (mobile-safe)
  seek.addEventListener("input", () => {
    offsetSec = Number(seek.value);
    if (!isRunning) previewAt(offsetSec);
    else updateSeekUI(offsetSec);
  });

  // iOS/Android: gesto de arrastar
  seek.addEventListener("touchstart", () => { isUserDrag = true; }, {passive:true});
  seek.addEventListener("touchend", async () => {
    isUserDrag = false;
    if (isRunning) await startFromOffset(Number(seek.value));
  }, {passive:true});

  // Desktop/Android (mouse)
  seek.addEventListener("mousedown", () => { isUserDrag = true; });
  window.addEventListener("mouseup", async () => {
    if (!isUserDrag) return;
    isUserDrag = false;
    if (isRunning) await startFromOffset(Number(seek.value));
  });

  // iOS: às vezes só dispara no change
  seek.addEventListener("change", async () => {
    offsetSec = Number(seek.value);
    if (isRunning) await startFromOffset(offsetSec);
    else previewAt(offsetSec);
  });

  // Botões
  startBtn.addEventListener("click", async () => {
    await startFromOffset(Number(seek.value));
  });

  stopBtn.addEventListener("click", () => {
    // para loop
    if (raf) cancelAnimationFrame(raf);
    raf = null;

    // para oscilador
    stopOscOnly();

    // mantém posição e UI
    offsetSec = Number(seek.value);
    setRunning(false);
    srInfo.textContent = "—";
    previewAt(offsetSec);

    // (opcional) manter ctx aberto para retomar rápido no mobile
    // Se quiser fechar para liberar recursos, descomente:
    // if (ctx){ try{ ctx.close(); }catch(e){} ctx=null; }
  });

  // Init
  const gInit = Number(vol.value);
  volLabel.textContent = Math.round(gInit*100) + "%";
  gainInfo.textContent = `${gInit.toFixed(3)} (≈ ${gainToDbfs(gInit).toFixed(1)} dBFS)`;

  seek.max = String(duration);
  seek.value = "0";
  offsetSec = 0;

  previewAt(0);
  setRunning(false);
})();
</script>

<!-- Service Worker (offline) -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./service-worker.js").catch(() => {});
    });
  }
</script>
</body>
</html>
